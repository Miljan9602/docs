openapi: 3.0.3
info:
  title: RFQ Protocol API
  description: |
    Request for Quote (RFQ) Protocol API for decentralized token swaps.

    The RFQ system consists of two components:
    - **RFQ Coordinator**: Off-chain coordinator that aggregates quotes from solvers
    - **Solver**: Provides quotes and liquidity
  version: 1.0.0
  contact:
    name: RFQ Protocol Team

servers:
  - url: https://dev-rfq.saphyre.xyz
    description: RFQ Coordinator (Production)
  - url: http://localhost:3004
    description: RFQ Coordinator (Local)
  - url: http://localhost:3003
    description: Solver (Local)

tags:
  - name: Coordinator - Config
    description: Chain configuration and contract addresses
  - name: Coordinator - Markets
    description: Get available trading pairs from RFQ Coordinator
  - name: Coordinator - Quote
    description: Request quotes from RFQ Coordinator
  - name: Coordinator - Intent
    description: Submit signed intents for settlement
  - name: Coordinator - Health
    description: Health check endpoints
  - name: Solver - Markets
    description: Get solver's supported markets
  - name: Solver - Quote
    description: Generate quotes from solver
  - name: Solver - Intent
    description: Sign counter-intents
  - name: Solver - Health
    description: Solver health checks

paths:
  /api/v1/config:
    get:
      tags:
        - Coordinator - Config
      summary: Get chain configuration
      description: |
        Returns configuration for a specific chain including contract addresses and quote TTL bounds.
        Use this endpoint to dynamically fetch contract addresses instead of hardcoding them.
      operationId: getConfig
      parameters:
        - name: chain_id
          in: query
          required: true
          description: Chain ID for a supported network
          schema:
            type: string
      responses:
        "200":
          description: Chain configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigResponse"
              example:
                status: "ok"
                chain_id: "1329"
                chain_name: "Sei"
                rfq_settlement_address: "0x..."
                permit2_address: "0xC6b7aC7Bbd8b456b67e8440694503cAC2Afb1d98"
                min_quote_ttl_ms: 15000
                max_quote_ttl_ms: 30000
        "400":
          description: Invalid or unsupported chain
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                validation_error:
                  summary: Missing chain_id
                  value:
                    status: "error"
                    error: "chain_id: Required"
                    code: "VALIDATION_INVALID_PARAM"
                unsupported_chain:
                  summary: Unsupported chain
                  value:
                    status: "error"
                    error: "Chain 999 is not supported. Supported chains: 1329"
                    code: "CHAIN_NOT_SUPPORTED"

  /api/v1/markets:
    get:
      tags:
        - Coordinator - Markets
      summary: Get available markets
      description: Returns all available trading pairs aggregated from registered solvers
      operationId: getMarkets
      parameters:
        - name: chain_id
          in: query
          required: true
          description: Chain ID for a supported network
          schema:
            type: string
      responses:
        "200":
          description: List of available markets
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarketsResponse"
              example:
                status: "ok"
                markets:
                  - input_token: "0x3894085ef7ff0f0aedf52e2a2704928d1ec074f1"
                    output_token: "0xe30fedd158a2e3b13e9badaeabafc5516e95e8c7"
                    min_size: 100.00
                    max_size: 5000.00
                  - input_token: "0xe30fedd158a2e3b13e9badaeabafc5516e95e8c7"
                    output_token: "0x3894085ef7ff0f0aedf52e2a2704928d1ec074f1"
                    min_size: 100.00
                    max_size: 12000.00
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
              example:
                status: "error"
                error: "chain_id: Required"
                code: "VALIDATION_INVALID_PARAM"

  /api/v1/quote:
    get:
      tags:
        - Coordinator - Quote
      summary: Get best quote
      description: |
        Queries all registered solvers in parallel and returns the best quote.
        Quotes have a TTL that varies by market volatility (15-30 seconds).
      operationId: getQuote
      parameters:
        - name: input_token
          in: query
          required: true
          description: Token address to sell (0x-prefixed, 40 hex chars, lowercase)
          schema:
            type: string
            pattern: "^0x[a-fA-F0-9]{40}$"
        - name: output_token
          in: query
          required: true
          description: Token address to buy
          schema:
            type: string
            pattern: "^0x[a-fA-F0-9]{40}$"
        - name: amount
          in: query
          required: true
          description: Amount to swap in wei (as numeric string)
          schema:
            type: string
            pattern: "^\\d+$"
        - name: chain_id
          in: query
          required: true
          description: Chain ID for a supported network
          schema:
            type: string
      responses:
        "200":
          description: Best quote from solvers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuoteResponse"
              example:
                status: "ok"
                quote_id: "rfq-q-550e8400-e29b-41d4-a716-446655440000"
                input_token: "0x3894085ef7ff0f0aedf52e2a2704928d1ec074f1"
                output_token: "0xe30fedd158a2e3b13e9badaeabafc5516e95e8c7"
                amount_in: "1000000000000000000"
                amount_out: "498500000000000000"
                fee: "5000000000000000"
                expiry: 1705612830000
                chain_id: "1329"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
              examples:
                invalid_address:
                  summary: Invalid address format
                  value:
                    status: "error"
                    error: "input_token: Invalid address"
                    code: "VALIDATION_INVALID_PARAM"
                invalid_amount:
                  summary: Invalid amount
                  value:
                    status: "error"
                    error: "amount: Expected number, received nan"
                    code: "VALIDATION_INVALID_PARAM"
        "404":
          description: Market not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                error: "No solvers support this pair"
                code: "MARKET_NO_MAKERS"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                error: "Too many quote requests, please wait before requesting again."
                code: "RATE_LIMIT_EXCEEDED"
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                error: "Unable to get quote from solvers"
                code: "QUOTE_UNAVAILABLE"

  /api/v1/intent:
    post:
      tags:
        - Coordinator - Intent
      summary: Submit signed intent
      description: |
        Submit a signed swap intent for on-chain settlement.
        The coordinator will:
        1. Validate the taker's EIP-712 signature
        2. Forward to the solver for counter-signature
        3. Execute the settlement on-chain
        4. Return the transaction hash
      operationId: submitIntent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IntentRequest"
            example:
              quote_id: "rfq-q-..."
              chain_id: "..."
              user_address: "0x..."
              swap_intent:
                inputToken: "0x..."
                outputToken: "0x..."
                inputAmount: "..."
                outputAmount: "..."
                unwrap: false
                frontendReferral: "0x0000000000000000000000000000000000000000000000000000000000000000"
              signature_params:
                deadline: "..."
                nonce: "..."
                signer: "0x..."
                signature: "0x..."
      responses:
        "200":
          description: Settlement successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IntentResponse"
              example:
                status: "ok"
                tx_hash: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
        "400":
          description: Validation or business logic error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                validation_error:
                  summary: Validation error
                  value:
                    status: "error"
                    error: "quote_id: Required, swap_intent.inputAmount: Required"
                    code: "VALIDATION_INVALID_PARAM"
                quote_expired:
                  summary: Quote expired
                  value:
                    status: "error"
                    error: "Quote has expired"
                    code: "QUOTE_EXPIRED"
                invalid_signature:
                  summary: Invalid signature
                  value:
                    status: "error"
                    error: "Invalid signature"
                    code: "INTENT_INVALID_SIGNATURE"
                amount_mismatch:
                  summary: Amount mismatch
                  value:
                    status: "error"
                    error: "Input amount does not match quoted amount"
                    code: "QUOTE_AMOUNT_MISMATCH"
                signer_mismatch:
                  summary: Signer mismatch
                  value:
                    status: "error"
                    error: "Signer does not match user address"
                    code: "VALIDATION_SIGNER_MISMATCH"
                quote_rejected:
                  summary: Quote rejected
                  value:
                    status: "error"
                    error: "Quote could not be fulfilled. Please request a new quote."
                    code: "QUOTE_REJECTED"
        "404":
          description: Quote not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                error: "Quote not found"
                code: "QUOTE_NOT_FOUND"
        "429":
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                error: "Too many intent submissions, please wait before trying again."
                code: "RATE_LIMIT_EXCEEDED"
        "500":
          description: Settlement failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                status: "error"
                error: "Settlement failed. Please try again."
                code: "SETTLEMENT_FAILED"

  /api/v1/health:
    get:
      tags:
        - Coordinator - Health
      summary: Health check
      description: Returns service health status including database connectivity
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: "ok"
                uptime: "3600s"
                database: "connected"
        "503":
          description: Service degraded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: "degraded"
                uptime: "3600s"
                database: "disconnected"

  /api/v1/health/live:
    get:
      tags:
        - Coordinator - Health
      summary: Liveness probe
      description: Simple liveness check for Kubernetes
      operationId: livenessProbe
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
              example:
                status: "ok"

  /api/v1/health/ready:
    get:
      tags:
        - Coordinator - Health
      summary: Readiness probe
      description: Readiness check for Kubernetes
      operationId: readinessProbe
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
              example:
                status: "ready"
        "503":
          description: Service not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  error:
                    type: string
              example:
                status: "not ready"
                error: "Database connection failed"

components:
  schemas:
    ConfigResponse:
      type: object
      required:
        - status
        - chain_id
        - chain_name
        - rfq_settlement_address
        - permit2_address
        - min_quote_ttl_ms
        - max_quote_ttl_ms
      properties:
        status:
          type: string
          enum: ["ok"]
        chain_id:
          type: string
          description: Chain ID
        chain_name:
          type: string
          description: Human-readable chain name
        rfq_settlement_address:
          type: string
          description: RFQSettlement contract address
        permit2_address:
          type: string
          description: Permit2 contract address
        min_quote_ttl_ms:
          type: integer
          description: Minimum quote TTL in milliseconds
        max_quote_ttl_ms:
          type: integer
          description: Maximum quote TTL in milliseconds

    MarketsResponse:
      type: object
      required:
        - status
        - markets
      properties:
        status:
          type: string
          enum: ["ok"]
        markets:
          type: array
          items:
            $ref: "#/components/schemas/Market"

    Market:
      type: object
      properties:
        input_token:
          type: string
          description: Input token address (lowercase)
        output_token:
          type: string
          description: Output token address (lowercase)
        min_size:
          type: number
          nullable: true
          description: Minimum trade size in input token units. null means no minimum.
        max_size:
          type: number
          nullable: true
          description: Maximum trade size in input token units. Dynamically derived from solver on-chain balances. null means no maximum.

    QuoteResponse:
      type: object
      required:
        - status
        - quote_id
        - input_token
        - output_token
        - amount_in
        - amount_out
        - chain_id
      properties:
        status:
          type: string
          enum: ["ok"]
        quote_id:
          type: string
          description: Unique quote identifier (format rfq-q-{uuid})
        input_token:
          type: string
          description: Input token address (lowercase)
        output_token:
          type: string
          description: Output token address (lowercase)
        amount_in:
          type: string
          description: Total input amount in wei (includes protocol fee)
        amount_out:
          type: string
          description: Output amount in wei
        fee:
          type: string
          description: Protocol fee amount in wei
        expiry:
          type: integer
          nullable: true
          description: Quote expiry timestamp (Unix ms). Null for indicative quotes.
        chain_id:
          type: string
          description: Chain ID

    IntentRequest:
      type: object
      required:
        - quote_id
        - chain_id
        - user_address
        - swap_intent
        - signature_params
      properties:
        quote_id:
          type: string
          description: Quote ID from previous quote request
        chain_id:
          type: string
          description: Chain ID
        user_address:
          type: string
          description: User's wallet address
        swap_intent:
          $ref: "#/components/schemas/SwapIntent"
        signature_params:
          $ref: "#/components/schemas/SignatureParams"

    SwapIntent:
      type: object
      properties:
        inputToken:
          type: string
          description: Token address to sell
        outputToken:
          type: string
          description: Token address to buy
        inputAmount:
          type: string
          description: Amount to sell in wei
        outputAmount:
          type: string
          description: Amount to receive in wei
        unwrap:
          type: boolean
          description: Whether to unwrap WETH to ETH
        frontendReferral:
          type: string
          description: Frontend referral code (32 bytes hex)

    SignatureParams:
      type: object
      properties:
        deadline:
          type: string
          description: Signature deadline (Unix timestamp as string)
        nonce:
          type: string
          description: Permit2 nonce
        signer:
          type: string
          description: Signer address
        signature:
          type: string
          description: EIP-712 signature (hex)

    IntentResponse:
      type: object
      required:
        - status
        - tx_hash
      properties:
        status:
          type: string
          enum: ["ok"]
        tx_hash:
          type: string
          description: Settlement transaction hash (0x-prefixed)

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: ["ok", "degraded"]
        uptime:
          type: string
          description: Service uptime (e.g., "3600s")
        database:
          type: string
          enum: ["connected", "disconnected"]

    ErrorResponse:
      type: object
      required:
        - status
        - error
        - code
      properties:
        status:
          type: string
          enum: ["error"]
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
          enum:
            - VALIDATION_INVALID_PARAM
            - VALIDATION_INVALID_CHAIN
            - VALIDATION_INVALID_ADDRESS
            - VALIDATION_INVALID_AMOUNT
            - VALIDATION_SIGNER_MISMATCH
            - MARKET_NOT_FOUND
            - MARKET_NOT_SUPPORTED
            - MARKET_NO_MAKERS
            - QUOTE_NOT_FOUND
            - QUOTE_EXPIRED
            - QUOTE_AMOUNT_MISMATCH
            - QUOTE_UNAVAILABLE
            - QUOTE_REJECTED
            - INTENT_INVALID_SIGNATURE
            - SETTLEMENT_FAILED
            - CHAIN_NOT_SUPPORTED
            - RATE_LIMIT_EXCEEDED
            - INTERNAL_ERROR

    ValidationError:
      type: object
      required:
        - status
        - error
        - code
      properties:
        status:
          type: string
          enum: ["error"]
        error:
          type: string
          description: "Human-readable error message describing the validation issue"
        code:
          type: string
          enum: ["VALIDATION_INVALID_PARAM"]
